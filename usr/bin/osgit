#!/bin/sh

# Treat undefined variables as errors
set -u

LIB="$ROOT"/lib/osgit && export LIB
ROOT="$(cd "$(dirname "$0")" || exit; pwd)"/.. && export ROOT_DIR
export OSGIT_PROFILE="/var/cache/osgit"
export TMP="/tmp/osgit"
export VERSION="0.4.0"


# shellcheck disable=SC1090
. "$LIB"/apt.sh
# shellcheck disable=SC1090
. "$LIB"/commands.sh
# shellcheck disable=SC1090
. "$LIB"/log.sh

__startup() {
  cd "$OSGIT_PROFILE" ||
    log_fatal "Could not get into $OSGIT_PROFILE"

  apt_get_installed >"$TMP"/packages.current
}

main() {
  test "$#" -eq 0 && log_fatal "Missing command"

  command=; args=

  test "$1" == "-d" && set -x && shift

  subcommand="$1" && shift

  test "$#" -ne 0 && args="$*"

  __startup

  # shellcheck disable=SC2048
  # shellcheck disable=SC2086
  case "$subcommand" in
    a*) commands_add $args ;;
    d*) commands_deploy $args ;;
    he*) commands_help ;;
    hi*) commands_log $args ;;
    ini*) commands_init ;;
    ins*) commands_add $args ;;
    li*) commands_list $args ;;
    lo*) commands_log $args ;;
    pi*) commands_pin $args ;;
    pu*) commands_rm $args ;;
    rem*) commands_rm $args ;;
    rev*) commands_revert $args ;;
    rm) commands_rm $args ;;
    ro*) commands_rollback $args ;;
    s*) commands_show $args ;;
    uni*) commands_rm $args ;;
    unp*) commands_unpin $args ;;
    upd*) commands_update $args ;;
    upg*) commands_upgrade $args ;;
    v*) echo "osgit $VERSION" ;;
    *) log_fatal "Invalid operation '$command'" ;;
  esac

  exit_clean
}

main "$@"
