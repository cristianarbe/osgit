#!/bin/sh

# Treat undefined variables as errors
set -u

export OSGIT_PROFILE="/var/cache/osgit"
export TMP="/tmp/osgit"
export VERSION="0.1"

APP_ROOT_DIR="$(
  cd "$(dirname "$0")" || exit
  pwd
)"/..
export APP_ROOT_DIR

for lib in apt cleanup commands diffs errors git print root menu; do
  # shellcheck disable=SC1090
  . "$APP_ROOT_DIR"/lib/osgit/"$lib".sh
done

startup() {
  test ! -d "$OSGIT_PROFILE" && mkdir "$OSGIT_PROFILE"

  cd "$OSGIT_PROFILE" ||
    fatal "Could not get into $OSGIT_PROFILE"

  if test ! -d .git; then
    git init
    get_installed >"$OSGIT_PROFILE"/packages
    add_commit "First commit"
  fi

  test ! -d "$TMP" && mkdir "$TMP"
  get_installed >"$TMP"/packages.current
}

main() {
  startup

  if test -n "$1"; then
    option="$1"
    shift
    get_installed >"$TMP"/packages.current
  fi

  # shellcheck disable=SC2048
  # shellcheck disable=SC2086
  case "$option" in
  a*) fn_add $* ;;
  d*) fn_deploy $* ;;
  he*) fn_help ;;
  hi*) fn_log $* ;;
  i*) fn_add $* ;;
  li*) fn_list $* ;;
  lo*) fn_log $* ;;
  pi*) fn_pin $* ;;
  pu*) fn_rm $* ;;
  rem*) fn_rm $* ;;
  rev*) fn_revert $* ;;
  rm) fn_rm $* ;;
  ro*) fn_rollback $* ;;
  s*) fn_show $* ;;
  uni*) fn_rm $* ;;
  unp*) fn_unpin $* ;;
  upd*) fn_update $* ;;
  upg*) fn_upgrade $* ;;
  v*) echo "osgit $VERSION" ;;
  *) fn_help ;;
  esac

  clean_exit
}

main "$@"
