#!/bin/sh
# Copyright 2019 Cristian Ariza
# Licensed under the EUPL
#
# Main executable

set -u

export VERSION="0.5.0"
PREFIX="$(cd "$(dirname "$0")"/.. || exit; pwd)"
OSGITPATH="$PREFIX"/var/cache/osgit
ORIGIN="$(pwd)"

# shellcheck source=../lib/osgit/apt.sh
. "$PREFIX"/lib/osgit/apt.sh
# shellcheck source=../lib/osgit/commands.sh
. "$PREFIX"/lib/osgit/commands.sh
# shellcheck source=../lib/osgit/log.sh
. "$PREFIX"/lib/osgit/log.sh

main() {
  args=
  subcommand=

  while test "$#" != 0; do
    if test "$1" = "-d"; then
      set -x
    elif test -z "$subcommand"; then
      subcommand="$1"
    else
      args="$*"
      break
    fi

    shift
  done

  case "$subcommand" in
    a* | c* | pi* | rev* | rm* | ro* | unp* | upd* | upg*)

      if ! cd "$OSGITPATH" 2> /dev/null; then
        log_fatal "Could not cd into $OSGITPATH"
      fi

      if test "$(id -u)" != 0; then
        log_fatal "this command must be executed as root"
      fi

      git_make_this_master > /dev/null 2>&1
      ;;
  esac

  case "$subcommand" in
    c* | pi* | rev* | ro* | s* | unp*)
      if test "$#" -ne 1; then
        log_fatal "incorrect number of arguments"
      fi
      ;;
  esac

  # shellcheck disable=SC2086
  case "$subcommand" in
    a*) commands_add $args ;;
    c*) commands_clone "$ORIGIN/$args" ;;
    d*) dpkg-query -Wf '${Installed-Size}\t${Package}\n' | sort -n ;;
    i*) commands_init ;;
    li*) cat "$OSGITPATH"/packages ;;
    lo*) git --git-dir="$OSGITPATH"/.git log --oneline ;;
    pi*) commands_pin $args ;;
    rev*) commands_revert $args ;;
    rm) commands_rm $args ;;
    ro*) commands_rollback $args ;;
    s*) commands_show $args ;;
    unp*) commands_unpin $args ;;
    upd*) commands_update $args ;;
    upg*) commands_upgrade $args ;;
    v*) apt-cache madison $args | sed 's/ | /=/';;
    '-v') echo "osgit $VERSION" ;;
    *) log_fatal "$(commands_help "$VERSION")" ;;
  esac

}

main "$@"
