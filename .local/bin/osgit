#!/bin/sh

set -e

if test -z "$APP_ROOT_DIR"; then
  cd "$(dirname "$0")"
  APP_ROOT_DIR="$(pwd)"/..
fi

OSGIT_PROFILE="$HOME/.osgit"

# shellcheck source=../lib/osgit/apt.sh
. "$APP_ROOT_DIR"/lib/osgit/apt.sh
# shellcheck source=../lib/osgit/cleanup.sh
. "$APP_ROOT_DIR"/lib/osgit/cleanup.sh
# shellcheck source=../lib/osgit/commands.sh
. "$APP_ROOT_DIR"/lib/osgit/commands.sh
# shellcheck source=../lib/osgit/diffs.sh
. "$APP_ROOT_DIR"/lib/osgit/diffs.sh
# shellcheck source=../lib/osgit/errors.sh
. "$APP_ROOT_DIR"/lib/osgit/errors.sh
# shellcheck source=../lib/osgit/git.sh
. "$APP_ROOT_DIR"/lib/osgit/git.sh

startup() {
  test ! -d "$OSGIT_PROFILE" && mkdir "$OSGIT_PROFILE"

  cd "$OSGIT_PROFILE" ||
    fatal "Could not get into $OSGIT_PROFILE"

  test ! -d .git && git init

  get_installed >"$OSGIT_PROFILE"/packages.current
}

main() {
  startup

  case "$1" in
  "") fatal "Option is missing." ;;
  add | rm | pull | clone | upgrade | rollback | deploy | log | list)
    # shellcheck disable=SC2086
    fn_$*
    ;;
  *) fatal "Option not recognized." ;;
  esac

  clean_exit
}

main "$@"
