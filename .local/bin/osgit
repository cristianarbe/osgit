#!/bin/sh

set -e

OSGIT_PROFILE="$HOME/.osgit"
VERSION="0.1"

if test -z "$APP_ROOT_DIR"; then
  cd "$(dirname "$0")"
  APP_ROOT_DIR="$(pwd)"/..
fi

for lib in apt cleanup commands diffs errors git print; do
  # shellcheck disable=SC1090
  . "$APP_ROOT_DIR"/lib/osgit/"$lib".sh
done

startup() {
  test ! -d "$OSGIT_PROFILE" && mkdir "$OSGIT_PROFILE"

  cd "$OSGIT_PROFILE" ||
    fatal "Could not get into $OSGIT_PROFILE"

  test ! -d .git && git init

  get_installed >"$OSGIT_PROFILE"/packages.current
}

main() {
  startup

  if test -z "$1"; then
    fatal "Option is missing."
  fi

  option="$1"
  shift

  case "$option" in
  a*) fn_add $* ;;
  d*) fn_deploy $* ;;
  i*) fn_add $* ;;
  li*) fn_list $* ;;
  lo*) fn_log $* ;;
  pi*) fn_pin $* ;;
  pu*) fn_rm $* ;;
  rev*) fn_revert $* ;;
  rem*) fn_rm $* ;;
  rm) fn_rm $* ;;
  ro*) fn_rollback $* ;;
  s*) fn_show $* ;;
  uni*) fn_rm $* ;;
  unp*) fn_unpin $* ;;
  upd*) fn_update $* ;;
  upg*) fn_upgrade $* ;;
  v*) echo "osgit $VERSION" ;;
  *) fatal "Option not recognized." ;;
  esac

  clean_exit
}

main "$@"
