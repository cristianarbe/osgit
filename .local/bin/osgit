#!/bin/sh

set -e

OSGIT_PROFILE="$HOME/.osgit"
VERSION="0.1"

if test -z "$APP_ROOT_DIR"; then
  cd "$(dirname "$0")"
  APP_ROOT_DIR="$(pwd)"/..
fi

for lib in apt cleanup commands diffs errors git print; do
  # shellcheck disable=SC1090
  . "$APP_ROOT_DIR"/lib/osgit/"$lib".sh
done

startup() {
  test ! -d "$OSGIT_PROFILE" && mkdir "$OSGIT_PROFILE"

  cd "$OSGIT_PROFILE" ||
    fatal "Could not get into $OSGIT_PROFILE"

  test ! -d .git && git init

  get_installed >"$OSGIT_PROFILE"/packages.current
}

main() {
  startup

  case "$1" in
  "") fatal "Option is missing." ;;
  add | rm | pull | clone | upgrade | rollback | \
    deploy | log | list | update | show | pin | unpin | revert)
    # shellcheck disable=SC2086
    fn_$*
    ;;
  version)
    echo "osgit $VERSION"
    ;;
  *) fatal "Option not recognized." ;;
  esac

  clean_exit
}

main "$@"
